<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Neo Map — Poles & Permits</title>

  <!-- Leaflet + Turf (CDNs) -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script defer src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <link rel="stylesheet" href="./styles.css">

  <!-- Local additions for legend icons + label chip -->
  <style>
    .job-label .job-label-chip{
      display:inline-block; padding:4px 6px; border-radius:8px;
      background: rgba(0,0,0,.35); color:#e6efff; font-weight:800; letter-spacing:.3px;
      box-shadow: 0 2px 10px rgba(0,0,0,.45); cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- FILTERS (Top-Left) -->
  <aside id="filters" class="panel panel--filters">
    <div class="bar">
      <h3>Advanced Filters</h3>
      <div class="row">
        <label class="chip">Match
          <select id="logic">
            <option value="AND">All (AND)</option>
            <option value="OR">Any (OR)</option>
          </select>
        </label>
        <button id="btnClear" class="btn btn-ghost" title="Reset filters">Reset</button>
      </div>
    </div>
    <div class="row" style="margin-bottom:6px">
      <div class="field">
        <small>Owner</small>
        <select id="qOwner">
          <option value="">All</option>
          <option value="BPUB">BPUB</option>
          <option value="AEP">AEP</option>
          <option value="MVEC">MVEC</option>
          <option value="OTHER">Other Utility</option>
          <option value="UNKNOWN">Unknown / Unset</option>
        </select>
      </div>
      <div class="field">
        <small>Permit Status</small>
        <select id="qStatus">
          <option value="">All</option>
          <option>NONE</option>
          <option>Created - NOT Submitted</option>
          <option>Submitted - Pending</option>
          <option>Approved</option>
          <option>Not Approved - Cannot Attach</option>
          <option>Not Approved - PLA Issues</option>
          <option>Not Approved - MRE Issues</option>
          <option>Not Approved - Other Issues</option>
        </select>
      </div>
      <div class="field" style="flex:1">
        <small>Search</small>
        <input id="qSearch" placeholder="Job, Tag, SCID, MR…"/>
      </div>
    </div>
    <div id="rules"></div>
    <div class="row" style="margin-top:10px">
      <button id="btnAddRule" class="btn">Add Condition</button>
      <button id="btnApply"   class="btn btn-accent">Apply</button>
    </div>
  </aside>

  <!-- LEGEND (Bottom-Left) -->
  <aside id="legend" class="panel panel--legend">
    <h3>Legend</h3>
    <div class="legend-grid">
      <div>
        <div class="muted mb6">Utility → Shape</div>
        <div class="item">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="#94a3b8" stroke="white" stroke-width="2"/></svg>
          <div>BPUB (circle)</div>
        </div>
        <div class="item">
          <svg viewBox="0 0 24 24"><polygon points="12,4 20,20 4,20" fill="#94a3b8" stroke="white" stroke-width="2"/></svg>
          <div>AEP (triangle)</div>
        </div>
        <div class="item">
          <svg viewBox="0 0 24 24"><rect x="5" y="7" width="14" height="10" rx="2" fill="#94a3b8" stroke="white" stroke-width="2"/></svg>
          <div>MVEC (square)</div>
        </div>
        <div class="item">
          <svg viewBox="0 0 24 24"><polygon points="12,2 15,9 22,10 17,14 18.8,21 12,17.5 5.2,21 7,14 2,10 9,9" fill="#9ca3af"/></svg>
          <div>Other Utility (star)</div>
        </div>
        <div class="item">
          <svg viewBox="0 0 24 24">
            <rect x="10.5" y="3" width="3" height="18" fill="#9ca3af"/>
            <rect x="3" y="10.5" width="18" height="3" fill="#9ca3af"/>
          </svg>
          <div>Unknown / Unset (gray +)</div>
        </div>
      </div>
      <div>
        <div class="muted mb6">Permit Status → Color</div>
        <div class="item"><span class="swatch" style="background:var(--chip-approved)"></span>Approved</div>
        <div class="item"><span class="swatch" style="background:var(--chip-pending)"></span>Submitted - Pending</div>
        <div class="item"><span class="swatch" style="background:var(--chip-created)"></span>Created - NOT Submitted</div>
        <div class="item"><span class="swatch" style="background:var(--chip-na-cannot)"></span>Not Approved - Cannot Attach</div>
        <div class="item"><span class="swatch" style="background:var(--chip-na-other)"></span>Not Approved - PLA/MRE/Other</div>
        <div class="item"><span class="swatch" style="background:var(--chip-none)"></span>NONE</div>
      </div>
    </div>
  </aside>

  <!-- TOOLS (Top-Right) -->
  <div id="tools" class="tools panel">
    <h3>Map Tools</h3>
    <div class="btnrow">
      <button id="btnFit" class="btn">Fit to Poles</button>
      <button id="btnToggleAreas" class="btn">Toggle Job Areas</button>
      <button id="btnReport" class="btn btn-accent">Open Insights</button>
      <button id="btnRefresh" class="btn">Refresh Data</button>
    </div>
    <p class="muted small">Click a job name to view its report. Click a pole for details.</p>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- REPORT PANEL -->
  <aside id="report" class="panel panel--report hidden">
    <div class="report-head">
      <div class="title">Insights & Assessment</div>
      <div class="muted small">Live analytics from poles.json + permits.json</div>
      <button id="btnReportClose" class="btn btn-ghost">Close</button>
    </div>
    <div id="reportBody" class="report-grid"></div>
  </aside>

  <!-- Modules -->
  <script>
    window.APP_CONFIG = {
      OWNER: 'DRGSolutions',
      REPO: 'BrownsvilleOMNIPermits',
      DEFAULT_BRANCH: 'main',
      DATA_DIR: 'data'
    };
  </script>
  <script type="module" src="./config.js"></script>
  <script type="module" src="./data.js"></script>
  <script type="module" src="./markers.js"></script>
  <script type="module" src="./areas.js"></script>
  <script type="module" src="./filters.js"></script>
  <script type="module" src="./ui.js"></script>
  <script type="module" src="./report.js"></script>
  <script type="module" src="./app.js"></script>
</body>
</html>
