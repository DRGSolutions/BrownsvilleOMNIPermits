<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRG Brownsville, TX Permit Management System</title>

  <style>
    :root { --bg:#0b0c10; --panel:#121318; --muted:#9aa3b2; --fg:#f3f4f6; --accent:#6ee7b7; --danger:#ef4444; --border:#1f2430; --chip:#0e1520; }
    * { box-sizing:border-box }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--fg); }
    header { padding:24px 16px; border-bottom:1px solid var(--border); background:linear-gradient(180deg, #0b0c10 0%, #0d0f14 100%); position:sticky; top:0; z-index:10; text-align:center }
    h1 { margin:0; font-size:24px; letter-spacing:.2px }
    main { max-width:1200px; margin:20px auto 56px; padding:0 16px }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px }
    .muted { color:var(--muted) }
    .btn { appearance:none; border:1px solid var(--border); background:#161922; color:var(--fg); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600 }
    .btn:hover { background:#1a1f2b }
    .btn:disabled { opacity:.6; cursor:not-allowed }
    .btn-accent { border-color:#1f3b2f; background:#0f2b22 }
    .btn-danger { border-color:#3a1e1e; background:#2a1515 }
    input, select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3242; background:#0f1219; color:var(--fg); }
    label { font-size:13px; color:var(--muted); display:block; margin-bottom:6px }
    .title { font-weight:700; font-size:16px; margin-bottom:6px }
    .small { font-size:12px }
    .kpi { display:flex; gap:14px; flex-wrap:wrap; margin:10px 0 0 }
    .kpi div { background:#0f1219; border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:13px; color:var(--muted) }
    .list { display:grid; gap:12px; max-height:600px; overflow:auto; padding-right:4px }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #283244; background:var(--chip); color:#c7d2fe }
    .chip-ok { color:var(--accent) }
    .chip-warn { color:#ffda6a; border-color:#5a4700 }
    .flex { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .row { display:grid; grid-template-columns: repeat(12, 1fr); gap:12px }
    .col-6 { grid-column: span 6 }
    .col-4 { grid-column: span 4 }
    .col-3 { grid-column: span 3 }
    .col-12 { grid-column: span 12 }
    @media (max-width: 1060px) { .grid-2 { grid-template-columns: 1fr } .list { max-height:none } }
  </style>
</head>
<body>
  <header>
    <h1>DRG Brownsville, TX Permit Management System</h1>
  </header>

  <main>
    <div class="grid-2">
      <!-- Left column: Filters, status, list -->
      <section class="card">
        <div class="title">Filters</div>
        <div class="grid-3" style="margin-bottom:12px;">
          <div>
            <label>Utility</label>
            <select id="selUtility"></select>
          </div>
          <div>
            <label>Job Name</label>
            <select id="selJob"></select>
          </div>
          <div>
            <label>Search Tag or SCID</label>
            <input id="searchTagScid" placeholder="e.g., 1234 or 076" />
          </div>
        </div>

        <div class="flex" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="title">Current Data</div>
            <div id="status" class="muted small">Loading…</div>
            <div class="kpi">
              <div>Poles: <b id="kPoles">—</b></div>
              <div>Permits: <b id="kPermits">—</b></div>
              <div>Loaded: <b id="kLoaded">—</b></div>
              <div>Commit: <b id="kSha">—</b></div>
            </div>
          </div>
        </div>

        <div id="pendingPanel" class="card" style="padding:12px; display:none; margin:12px 0 10px;">
          <div class="title" style="margin-bottom:6px;">Change Monitor</div>
          <div id="pendingList" class="small muted">No pending changes.</div>
        </div>

        <div id="list" class="list"></div>
      </section>

      <!-- Right column: Forms & Admin -->
      <section class="card">
        <div class="title" style="margin-bottom:8px;">Pole Editor</div>
        <form id="formPole" class="card" style="padding:14px; margin-bottom:14px;">
          <div class="row">
            <div class="col-6"><label>Mode</label>
              <select name="mode">
                <option value="upsert">Upsert (create if missing)</option>
                <option value="update">Update existing</option>
              </select>
            </div>
            <div class="col-6"><label>Owner</label>
              <select name="owner" id="pole_owner"></select>
            </div>

            <div class="col-4"><label>Job Name *</label><input name="job_name" required /></div>
            <div class="col-4"><label>Tag *</label><input name="tag" required /></div>
            <div class="col-4"><label>SCID *</label><input name="SCID" required /></div>

            <div class="col-6"><label>Pole Spec</label><input name="pole_spec" /></div>
            <div class="col-6"><label>Proposed Spec</label><input name="proposed_spec" /></div>

            <div class="col-6"><label>Latitude</label><input name="lat" type="number" step="any" /></div>
            <div class="col-6"><label>Longitude</label><input name="lon" type="number" step="any" /></div>

            <div class="col-12"><label>MR Level</label><input name="mr_level" /></div>
          </div>
          <div class="flex" style="margin-top:10px;">
            <button class="btn btn-accent" type="submit">Save Pole</button>
            <span id="msgPole" class="muted small"></span>
          </div>
        </form>

        <div class="title" style="margin-bottom:8px;">Permit Editor</div>
        <form id="formPermit" class="card" style="padding:14px; margin-bottom:14px;">
          <div class="small muted" id="selPoleSummary">No pole selected.</div>
          <div class="row" style="margin-top:8px;">
            <div class="col-12"><label>Select Existing Permit (or choose “New”)</label>
              <select id="permit_select">
                <option value="">— New —</option>
              </select>
            </div>

            <div class="col-6"><label>Permit ID *</label><input name="permit_id" id="permit_id" required /></div>
            <div class="col-6"><label>Status *</label>
              <select name="permit_status" id="permit_status"></select>
            </div>

            <div class="col-6"><label>Submitted By *</label><input name="submitted_by" id="submitted_by" required /></div>
            <div class="col-6"><label>Submitted At</label><input name="submitted_at" id="submitted_at" type="date" /></div>

            <div class="col-12"><label>Notes</label><textarea name="notes" id="notes" rows="3" placeholder="Add any notes…"></textarea></div>
          </div>
          <div class="flex" style="margin-top:10px;">
            <button class="btn btn-accent" type="submit">Save Permit</button>
            <span id="msgPermit" class="muted small"></span>
          </div>
        </form>

        <div class="title" style="margin-bottom:8px;">Admin</div>
        <div class="card" style="padding:14px;">
          <div class="row">
            <div class="col-4">
              <label>Export — Utility</label>
              <select id="adminUtility"></select>
            </div>
            <div class="col-4">
              <label>Export — Job</label>
              <select id="adminJob"></select>
            </div>
            <div class="col-4">
              <label>Export — Permit Status</label>
              <select id="adminStatus">
                <option value="">All</option>
              </select>
            </div>
            <div class="col-12 flex">
              <button id="btnExportPoles" class="btn">Export Poles CSV</button>
              <button id="btnExportPermits" class="btn">Export Permits CSV</button>
            </div>
          </div>

          <hr style="border-color:#222; margin:14px 0" />

          <div class="row">
            <div class="col-12"><div class="small muted">Mass create permits for the <b>currently selected Job</b> (left filters) — only allowed when the job has <b>no existing permits</b>.</div></div>
            <div class="col-4">
              <label>Template Status *</label>
              <select id="mass_status"></select>
            </div>
            <div class="col-4">
              <label>Template Submitted By *</label>
              <input id="mass_submitted_by" />
            </div>
            <div class="col-4">
              <label>Template Submitted At</label>
              <input id="mass_submitted_at" type="date" />
            </div>
            <div class="col-12">
              <label>Template Notes</label>
              <textarea id="mass_notes" rows="3"></textarea>
            </div>
            <div class="col-12 flex">
              <button id="btnMassCreate" class="btn btn-danger">Create Permits For Job</button>
              <span id="msgMass" class="muted small"></span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- App bootstrap -->
  <script type="module" src="./assets/js/app.js"></script>
</body>
</html>
