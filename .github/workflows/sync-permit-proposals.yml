name: Sync permit proposal numbers

on:
  push:
    branches:
      - main
      - master
    paths:
      - "**/permits.json"
      - "!**/backup/**"

concurrency:
  group: sync-permit-proposals
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Normalize and propagate proposal numbers
        env:
          BASE_SHA: ${{ github.event.before }}
          HEAD_SHA: ${{ github.sha }}
          # If your note field is "note" not "notes", set NOTE_FIELD to "note"
          # NOTE_FIELD: "notes"
        run: |
          python scripts/sync_permit_proposals.py

      - name: Create pull request if changes exist
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "Sync proposal numbers in permits.json"
          title: "Sync proposal numbers across related permits"
          body: |
            Automated update:
            - Ensures proposal numbers appear as "Proposal ####-##-####" in permit notes.
            - Propagates the canonical proposal number across permits sharing the same base permit_id.
            - Does not modify anything under any "backup/" folder.
          branch: automation/sync-permit-proposals
          delete-branch: true
